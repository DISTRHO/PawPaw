name: bootstrap-plugins

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'
env:
  DEBIAN_FRONTEND: noninteractive
  HOMEBREW_NO_AUTO_UPDATE: 1

jobs:
  bootstrap-common:
    strategy:
      matrix:
        include:
          - target: linux
            os: ubuntu-18.04
          - target: macos-old
            os: ubuntu-18.04
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - name: Set up cache
        uses: actions/cache@v2
        with:
          path: |
            ~/PawPawBuilds/builds
            ~/PawPawBuilds/debs
            ~/PawPawBuilds/downloads
            ~/PawPawBuilds/targets
          key: bootstrap-common-${{ matrix.target }}
      - name: Restore debian package cache
        run: |
          if [ -d ~/PawPawBuilds/debs ] && [ "$(ls ~/PawPawBuilds/debs | wc -l)" -ne 0 ]; then \
            sudo cp ~/PawPawBuilds/debs/*.deb /var/cache/apt/archives/; \
          fi
      - name: Set up repositories
        if: ${{ matrix.target }} == 'macos-old'
        run: |
          sudo add-apt-repository -y ppa:kxstudio-debian/kxstudio
          sudo add-apt-repository -y ppa:kxstudio-debian/toolchain
          sudo apt-get update -qq
          sudo apt-get install -y kxstudio-repos
          sudo apt-get update -qq
      - name: Set up cross-compiler
        if: ${{ matrix.target }} == 'macos-old'
        run: |
          mkdir -p ~/PawPawBuilds/debs
          cd ~/PawPawBuilds/debs && \
          if [ ! -f 'apple-uni-sdk-10.5_20110407-0.flosoft1_amd64.deb' ]; then \
            wget -c 'https://launchpad.net/~kxstudio-debian/+archive/ubuntu/toolchain/+files/apple-uni-sdk-10.5_20110407-0.flosoft1_amd64.deb'; \
          fi && \
          if [ ! -f 'apple-x86-odcctools_758.159-0kxstudio2_amd64.deb' ]; then \
            wget -c 'https://launchpad.net/~kxstudio-debian/+archive/ubuntu/toolchain/+files/apple-x86-odcctools_758.159-0kxstudio2_amd64.deb'; \
          fi && \
          if [ ! -f 'apple-x86-gcc_4.2.1~5646-1kxstudio2_amd64.deb' ]; then \
            wget -c 'https://launchpad.net/~kxstudio-debian/+archive/ubuntu/toolchain/+files/apple-x86-gcc_4.2.1~5646-1kxstudio2_amd64.deb'; \
          fi && \
          sudo dpkg -i \
            'apple-uni-sdk-10.5_20110407-0.flosoft1_amd64.deb' \
            'apple-x86-odcctools_758.159-0kxstudio2_amd64.deb' \
            'apple-x86-gcc_4.2.1~5646-1kxstudio2_amd64.deb'
      - name: Set up dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -yq build-essential curl cmake jq meson
          # extra, for using system libraries
          sudo apt-get install -yq libglib2.0-dev
      - name: Cache debian packages
        run: |
            mkdir -p ~/PawPawBuilds/debs
            sudo mv /var/cache/apt/archives/*.deb ~/PawPawBuilds/debs/
      - name: Run bootstrap
        shell: bash
        run: |
          ./bootstrap-common.sh ${{ matrix.target }} && ./.cleanup.sh ${{ matrix.target }}
      - name: Pack bootstrap build
        shell: bash
        run: |
          tar -C ~/PawPawBuilds -czf bootstrap-common-${{ matrix.target }}.tar.gz builds targets
      - uses: actions/upload-artifact@v2
        with:
          name: bootstrap-common-${{ matrix.target }}
          path: bootstrap-common-${{ matrix.target }}.tar.gz

  bootstrap-plugins:
    strategy:
      matrix:
        include:
          - target: linux
            os: ubuntu-18.04
          - target: macos-old
            os: ubuntu-18.04
    runs-on: ${{ matrix.os }}
    needs: bootstrap-common
    steps:
      - uses: actions/checkout@v2
      - name: Set up cache
        uses: actions/cache@v2
        with:
          path: |
            ~/PawPawBuilds/builds
            ~/PawPawBuilds/debs
            ~/PawPawBuilds/downloads
            ~/PawPawBuilds/targets
          key: bootstrap-plugins-${{ matrix.target }}
      - name: Restore debian package cache
        run: |
          if [ -d ~/PawPawBuilds/debs ] && [ "$(ls ~/PawPawBuilds/debs | wc -l)" -ne 0 ]; then \
            sudo cp ~/PawPawBuilds/debs/*.deb /var/cache/apt/archives/; \
          fi
      - name: Set up repositories
        if: ${{ matrix.target }} == 'macos-old'
        run: |
          sudo add-apt-repository -y ppa:kxstudio-debian/kxstudio
          sudo add-apt-repository -y ppa:kxstudio-debian/toolchain
          sudo apt-get update -qq
          sudo apt-get install -y kxstudio-repos
          sudo apt-get update -qq
      - name: Set up cross-compiler
        if: ${{ matrix.target }} == 'macos-old'
        run: |
          mkdir -p ~/PawPawBuilds/debs
          cd ~/PawPawBuilds/debs && \
          if [ ! -f 'apple-uni-sdk-10.5_20110407-0.flosoft1_amd64.deb' ]; then \
            wget -c 'https://launchpad.net/~kxstudio-debian/+archive/ubuntu/toolchain/+files/apple-uni-sdk-10.5_20110407-0.flosoft1_amd64.deb'; \
          fi && \
          if [ ! -f 'apple-x86-odcctools_758.159-0kxstudio2_amd64.deb' ]; then \
            wget -c 'https://launchpad.net/~kxstudio-debian/+archive/ubuntu/toolchain/+files/apple-x86-odcctools_758.159-0kxstudio2_amd64.deb'; \
          fi && \
          if [ ! -f 'apple-x86-gcc_4.2.1~5646-1kxstudio2_amd64.deb' ]; then \
            wget -c 'https://launchpad.net/~kxstudio-debian/+archive/ubuntu/toolchain/+files/apple-x86-gcc_4.2.1~5646-1kxstudio2_amd64.deb'; \
          fi && \
          sudo dpkg -i \
            'apple-uni-sdk-10.5_20110407-0.flosoft1_amd64.deb' \
            'apple-x86-odcctools_758.159-0kxstudio2_amd64.deb' \
            'apple-x86-gcc_4.2.1~5646-1kxstudio2_amd64.deb'
      - name: Set up dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -yq build-essential curl cmake jq meson
          # extra, for using system libraries
          sudo apt-get install -yq libglib2.0-dev
      - name: Cache debian packages
        run: |
            mkdir -p ~/PawPawBuilds/debs
            sudo mv /var/cache/apt/archives/*.deb ~/PawPawBuilds/debs/
      - name: Download bootstrap-common-${{ matrix.target }}
        uses: actions/download-artifact@v2
        with:
          name: bootstrap-common-${{ matrix.target }}
          path: ~/PawPawBuilds
      - name: Display structure of downloaded files
        run: ls ~/PawPawBuilds
      - name: Extract downloaded artifact
        shell: bash
        run: |
            cd ~/PawPawBuilds && \
            tar xf bootstrap-common-${{ matrix.target }}.tar.gz
      - name: Display structure of downloaded files
        run: find ~/PawPawBuilds
      - name: Run bootstrap
        shell: bash
        run: |
          ./bootstrap-plugins.sh ${{ matrix.target }} && ./.cleanup.sh ${{ matrix.target }}
      - name: Pack bootstrap build
        shell: bash
        run: |
          tar -C ~/PawPawBuilds -czf bootstrap-plugins-${{ matrix.target }}.tar.gz builds targets
      - uses: actions/upload-artifact@v2
        with:
          name: bootstrap-plugins-${{ matrix.target }}
          path: bootstrap-plugins-${{ matrix.target }}.tar.gz
